# 新功能说明文档

## 概述

本次更新为 CRCON QQ Bot 添加了两个重要的新功能：
1. **多服务器支持** - 支持动态配置和管理多个游戏服务器
2. **权限组系统** - 提供灵活的权限管理和用户分组功能

## 🖥️ 多服务器支持

### 功能特点

- **动态配置加载**：支持通过 YAML 配置文件动态管理服务器
- **热重载**：配置文件变更时自动重新加载，无需重启机器人
- **向后兼容**：完全兼容原有的传统配置方式
- **灵活扩展**：可轻松添加新服务器或修改现有服务器配置

### 配置文件

#### 主配置文件：`servers_config.yaml`

```yaml
# 全局设置
global_settings:
  default_server: "server_1"
  api_request:
    timeout: 30
    retry_times: 3
    retry_delay: 1.0
  cache:
    enable: true
    expire_time: 300
  health_check:
    enable: true
    interval: 300

# 服务器配置
servers:
  server_1:
    name: "AAA服务器"
    display_name: "AAA"
    description: "主要游戏服务器"
    connection:
      api_base_url: "http://127.0.0.1:8010/api"
      api_token: "${CRCON_API_TOKEN}"
    settings:
      max_players: 100
      region: "Asia"
      timezone: "Asia/Shanghai"
    features:
      enable_auto_restart: true
      enable_map_rotation: true
      enable_player_stats: true
    permissions:
      admin_groups: ["123456789"]
      player_groups: ["987654321"]
    custom:
      server_type: "production"
      priority: 1
```

### 新增命令

| 命令 | 别名 | 功能 | 权限要求 |
|------|------|------|----------|
| `/服务器列表` | `/服务器` | 查看所有可用服务器 | 无 |
| `/服务器详情 [服务器ID]` | `/服务器信息` | 查看指定服务器详细信息 | 无 |
| `/重载配置` | `/刷新配置` | 重新加载服务器配置 | 管理员 |

### 使用示例

```
/服务器列表
# 显示所有可用服务器及其状态

/服务器详情 server_1
# 显示 server_1 的详细配置信息

/查服 server_1
# 查询 server_1 的实时状态（支持新的服务器ID格式）
```

## 🔐 权限组系统

### 功能特点

- **多级权限**：支持主人、超级管理员、普通管理员三级权限
- **服务器组管理**：可为不同服务器组配置独立的权限
- **功能权限控制**：细粒度控制各项功能的访问权限
- **QQ群组绑定**：支持将权限组绑定到特定的QQ群
- **操作日志**：记录所有权限变更操作

### 配置文件

#### 权限组配置：`config/permission_groups.yaml`

```yaml
# 服务器组配置
server_groups:
  group_a:
    name: "服务器组A"
    description: "主要服务器组，包含核心游戏服务器"
    game_servers:
      - server_id: "server_1"
        name: "AAA服务器"
        enabled: true
      - server_id: "server_2"
        name: "BBB服务器"
        enabled: true
    permissions:
      owners: ["123456789"]
      super_admins: ["987654321"]
      admins: ["111222333"]
    allowed_groups: ["444555666", "777888999"]
    features:
      allow_kick: true
      allow_ban: true
      allow_map_change: true
      allow_player_list: true
      allow_server_management: true
```

### 权限级别说明

| 权限级别 | 英文标识 | 权限范围 |
|----------|----------|----------|
| 👑 主人 | `owner` | 所有权限，包括权限管理 |
| ⭐ 超级管理员 | `super_admin` | 大部分管理权限，不能管理权限 |
| 🛡️ 普通管理员 | `admin` | 基础管理权限 |
| 👤 普通用户 | `user` | 只能查询信息 |

### 新增命令

| 命令 | 别名 | 功能 | 权限要求 |
|------|------|------|----------|
| `/权限组列表` | `/权限组`, `/服务器组` | 查看所有权限组 | 无 |
| `/权限组详情 [组ID]` | `/服务器组详情` | 查看权限组详细信息 | 无 |
| `/我的权限` | `/权限查询` | 查看自己的权限信息 | 无 |
| `/添加权限 [QQ号] [组ID] [权限级别]` | `/授权` | 添加用户权限 | 管理员 |
| `/移除权限 [QQ号] [组ID]` | `/取消授权` | 移除用户权限 | 管理员 |
| `/重载权限配置` | `/刷新权限` | 重新加载权限配置 | 管理员 |

### 使用示例

```
/权限组列表
# 显示所有权限组及其基本信息

/权限组详情 group_a
# 显示 group_a 的详细权限配置

/我的权限
# 查看自己在各个权限组中的权限级别

/添加权限 123456789 group_a admin
# 将用户 123456789 添加为 group_a 的普通管理员

/移除权限 123456789 group_a
# 从 group_a 中移除用户 123456789 的权限
```

## 🔧 查服功能优化

### 改进内容

- **移除下一张地图显示**：简化界面，专注于当前游戏状态
- **优化地图名称显示**：改进中文地图名称的显示逻辑
- **保持核心功能**：保留比分、人数、剩余时间等关键信息

### 显示效果

```
🖥️ AAA服务器 状态信息
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🗺️ 当前地图：卡朗坦 (Warfare)
⚔️ 比分：盟军 2 - 1 轴心
👥 在线人数：85/100
⏰ 剩余时间：25:30
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 📋 更新的帮助系统

### 新增帮助内容

帮助命令现在包含了所有新功能的说明：

- **服务器管理**：服务器列表、详情查询、配置重载
- **权限管理**：权限组管理、用户权限操作、配置管理
- **使用示例**：包含新功能的实际使用示例

## 🔄 向后兼容性

### 完全兼容

- **传统配置**：原有的 `.env` 配置方式继续有效
- **命令格式**：所有原有命令保持不变
- **数据结构**：现有数据和配置无需迁移

### 平滑升级

1. **可选启用**：新功能为可选，不影响现有部署
2. **渐进迁移**：可以逐步迁移到新的配置方式
3. **回退支持**：如有问题可随时回退到传统配置

## 🚀 部署说明

### 新增依赖

```bash
pip install watchdog>=2.1.0
```

### 配置文件

1. **创建服务器配置**：复制并修改 `servers_config.yaml`
2. **创建权限配置**：复制并修改 `config/permission_groups.yaml`
3. **更新环境变量**：确保 `CRCON_API_TOKEN` 等变量正确设置

### 验证部署

运行测试脚本验证新功能：

```bash
python test_new_features.py
```

## 📝 注意事项

### 配置文件安全

- **敏感信息**：API令牌等敏感信息使用环境变量
- **文件权限**：确保配置文件的读写权限正确
- **备份配置**：定期备份重要的配置文件

### 性能考虑

- **文件监听**：配置文件监听功能会占用少量系统资源
- **缓存机制**：启用缓存可以提高响应速度
- **健康检查**：定期健康检查有助于及时发现问题

### 故障排除

1. **配置语法**：检查 YAML 文件语法是否正确
2. **权限设置**：确认文件和目录权限设置
3. **日志查看**：查看机器人日志了解详细错误信息
4. **测试脚本**：使用测试脚本验证功能状态

## 🎯 未来规划

### 计划功能

- **Web管理界面**：提供图形化的配置管理界面
- **更多权限级别**：支持更细粒度的权限控制
- **服务器集群**：支持服务器集群和负载均衡
- **统计分析**：提供服务器使用情况统计

### 反馈渠道

如有问题或建议，请通过以下方式反馈：
- 提交 Issue 到项目仓库
- 联系项目维护者
- 参与社区讨论

---

**版本信息**：v2.0.0  
**更新日期**：2024-10-30  
**兼容性**：向后兼容 v1.x 版本