# 更新日志

本文档记录了 CRCON QQ Bot 的版本更新历史和重要变更。

## [2.1.0] - 2024-12-XX

### 🆕 新增功能

#### 增强玩家列表功能
- **团队视图**：新增 `/团队视图` 命令，按小队分组显示玩家信息
- **详细玩家信息**：优化 `/详细玩家列表` 命令，显示UID、阵营、兵种等详细信息
- **数据缓存**：实现玩家数据缓存机制，每6分钟自动更新，提升响应速度
- **API集成**：直接从CRCON API获取团队视图数据，确保数据准确性

### 🔧 功能优化

#### API客户端改进
- **新增API方法**：在 `CRCONAPIClient` 中添加 `get_team_view` 方法
- **错误处理**：完善API调用的错误处理机制
- **配置兼容**：修复多服务器配置访问问题

#### 帮助系统更新
- **功能说明**：更新 `/帮助` 和 `/管理帮助` 命令，添加新功能说明
- **使用示例**：包含团队视图和详细玩家列表的使用示例
- **文档同步**：同步更新README.md和COMMANDS.md文档

### 🐛 问题修复

- **配置属性错误**：修复 `enhanced_player_list.py` 中 `config.servers` 属性不存在的问题
- **API方法调用**：修复 `get_detailed_players` 方法不存在的问题，改用正确的API端点
- **服务器配置**：优化多服务器配置的访问方式，使用 `validate_server_num` 和 `get_api_base_url` 函数

## [2.0.0] - 2024-10-30

### 🆕 新增功能

#### 多服务器支持
- **动态配置管理**：支持通过 `servers_config.yaml` 配置多个服务器
- **热重载配置**：配置文件变更时自动重新加载，无需重启
- **服务器管理命令**：
  - `/服务器列表` - 查看所有可用服务器
  - `/服务器详情 [服务器ID]` - 查看服务器详细信息
  - `/重载配置` - 重新加载服务器配置
- **灵活的服务器标识**：支持字符串ID（如 `server_1`）和传统数字ID

#### 权限组系统
- **多级权限管理**：支持主人、超级管理员、普通管理员三级权限
- **服务器组绑定**：可将权限组绑定到特定的QQ群和服务器组
- **权限管理命令**：
  - `/权限组列表` - 查看所有权限组
  - `/权限组详情 [组ID]` - 查看权限组详细信息
  - `/我的权限` - 查看自己的权限信息
  - `/添加权限 [QQ号] [组ID] [权限级别]` - 添加用户权限
  - `/移除权限 [QQ号] [组ID]` - 移除用户权限
  - `/重载权限配置` - 重新加载权限配置
- **操作日志**：记录所有权限变更操作

### 🔧 功能优化

#### 查服功能改进
- **简化显示**：移除下一张地图显示，专注于当前状态
- **优化地图名称**：改进中文地图名称的显示逻辑
- **保持核心信息**：保留比分、人数、剩余时间等关键信息

#### 帮助系统更新
- **新功能说明**：添加多服务器和权限管理功能的帮助信息
- **使用示例**：包含新功能的实际使用示例
- **分类整理**：按功能类别重新组织帮助内容

### 🔄 向后兼容

- **完全兼容**：所有原有配置和命令保持不变
- **平滑升级**：新功能为可选，不影响现有部署
- **渐进迁移**：可以逐步迁移到新的配置方式

### 📦 依赖更新

- **新增依赖**：`watchdog>=2.1.0` - 用于配置文件监听

### 🐛 修复问题

- **类型导入**：修复 `config.py` 中缺少 `Dict` 类型导入的问题
- **模块导入**：优化权限管理模块的导入逻辑

### 📝 文档更新

- **新功能文档**：添加 `NEW_FEATURES.md` 详细说明新功能
- **README更新**：更新主文档，添加新功能简介
- **配置示例**：提供完整的配置文件示例

---

## [1.1.0] - 2024-12-22

### 新增功能
- **三级权限管理系统**
  - 主人权限 (OWNER)：拥有所有系统权限，配置在 `.env` 文件中
  - 超级管理员权限 (SUPER_ADMIN)：拥有所有管理员权限，可管理普通管理员
  - 普通管理员权限 (ADMIN)：拥有游戏管理命令权限

- **权限管理命令**
  - `/添加管理员` - 添加普通管理员（需要超级管理员权限）
  - `/删除管理员` - 删除普通管理员（需要超级管理员权限）
  - `/管理员列表` - 查看管理员列表（需要超级管理员权限）
  - `/权限信息` - 查看权限信息（需要超级管理员权限）

### 技术改进
- **权限系统重构**
  - 实现 `PermissionManager` 类进行权限管理
  - 支持动态权限数据存储（JSON文件）
  - 向后兼容旧的 `SUPERUSER` 权限系统
  - 完整的权限检查和验证机制

- **命令权限更新**
  - 普通管理员命令：使用 `ADMIN` 权限
  - 超级管理员命令：使用 `SUPER_ADMIN` 权限
  - 系统命令：使用 `OWNER` 权限

### 文档更新
- 更新 `COMMANDS.md` 权限系统说明
- 更新 `README.md` 功能特性和使用指南
- 添加权限管理命令详细说明

## [1.0.2] - 2025-10-17

### ✨ 新功能

#### 💬 消息管理功能

**私信玩家功能**
- 新增 `/私信玩家` 命令，支持向指定玩家发送私信
- 支持多种玩家序号格式：单个序号、逗号分隔、范围格式、混合格式
- 命令别名：`/私信`、`/message`
- 智能参数解析：自动识别服务器编号和消息内容
- 详细的发送结果反馈，包括成功和失败统计

**全体私信功能**
- 新增 `/全体私信` 命令，支持向所有在线玩家发送私信
- 命令别名：`/广播私信`、`/broadcast`
- 安全限制：最多支持100名在线玩家
- 智能服务器编号识别
- 批量发送进度跟踪和错误处理

**序号解析系统**
- 实现了强大的玩家序号解析功能
- 支持格式：`1`、`1,3,5`、`1-5`、`1,3-5,7`
- 自动去重和排序
- 完善的错误处理和用户友好的错误提示

**技术特性**
- 基于现有 `message_player` API 实现
- 完整的异常处理和日志记录
- 权限控制：需要管理员权限
- 参数验证：序号范围1-100，服务器编号1-2

### 📚 文档更新

**COMMANDS.md 更新**
- 新增消息管理部分的完整文档
- 详细的命令格式说明和参数解释
- 丰富的使用示例和成功提示示例
- 添加了玩家序号格式的专门说明
- 更新了常见错误和解决方案
- 扩展了高级用法和组合命令示例

**测试覆盖**
- 创建了专门的测试文件验证核心逻辑
- 15个测试用例，93.3%通过率
- 覆盖正常用例和错误处理
- 验证了参数解析的正确性

## [1.0.1] - 2025-10-17

### 🔧 修复和改进

#### 🗺️ 地图切换功能优化

**问题修复**
- 修复了 `set_map` API 返回 `result: null` 时的错误判断逻辑
- 修复了地图名称格式不一致导致的切换失败问题
- 修复了 GameState 解析错误，正确提取地图名称字符串
- 更新了 `COMMON_MAPS` 列表，与服务器实际轮换匹配

**功能改进**
- 优化了成功判断逻辑：基于 `failed` 和 `error` 字段而非 `result` 字段
- 改进了用户提示信息：从"成功更换地图"改为"地图切换命令已执行"
- 添加了"预计1分钟后生效"的时间提示，提升用户体验
- 地图列表现在包含10个服务器轮换中的地图，匹配率达到 41.7%

**技术细节**
- API 权限验证：确认所有必要权限正常
- 地图名称格式：统一使用正确的字符串格式（如 `carentan_warfare`）
- 错误处理：改进了 API 响应的解析和错误处理逻辑

#### 📋 调查和文档

**问题调查**
- 完成了对 `set_map` 返回 `null` 问题的全面调查
- 创建了详细的调查报告 `MAP_INVESTIGATION_REPORT.md`
- 验证了 API 权限、地图名称格式和服务器配置

**测试验证**
- 创建了多个测试脚本验证修复效果
- 确认了地图切换命令的正确执行
- 验证了用户提示信息的准确性

## [1.0.0] - 2025-10-16

### 🎉 首次发布

#### ✨ 新功能

**玩家功能**
- 服务器状态查询（`/服务器信息`、`/server`、`/status`）
- VIP 状态查询（`/查询vip`、`/checkvip`）
- 帮助信息显示（`/帮助`、`/help`）

**管理员功能**
- 在线玩家列表查询（`/玩家列表`、`/players`）
- 玩家踢出功能（`/踢出`、`/kick`）
- 玩家封禁功能（临时/永久）（`/临时封禁`、`/永久封禁`）
- 玩家惩罚功能（`/惩罚`、`/punish`）
- 玩家队伍切换（立即/死亡后）（`/立即切换`、`/死亡切换`）
- 地图更换功能（`/换图`、`/changemap`）
- 空闲踢出时间设置（`/设置空闲时间`、`/setidle`）
- 管理员帮助信息（`/管理帮助`、`/adminhelp`）

**系统功能**
- 机器人状态监控（`/状态`、`/机器人状态`）
- API 连接测试（`/API测试`、`/apitest`）
- 机器人重启功能（`/重启机器人`、`/restart`）
- 自动健康检查（每 5 分钟）

#### 🏗️ 技术特性

**架构设计**
- 基于 NoneBot2 框架构建
- 支持 OneBot V11 协议
- 模块化插件架构
- 异步 HTTP 客户端

**API 集成**
- 完整的 CRCON API 客户端实现
- 支持双服务器配置
- 自动重试机制
- 连接池管理

**配置管理**
- 基于 Pydantic 的配置验证
- 环境变量支持
- 灵活的权限控制
- 多语言命令别名

**日志系统**
- 结构化日志记录
- 日志轮转（每日）
- 多级别日志支持
- 错误追踪

**错误处理**
- 全面的异常捕获
- 用户友好的错误消息
- API 故障自动恢复
- 优雅的降级处理

#### 📦 依赖包

**核心依赖**
- `nonebot2>=2.0.0` - 机器人框架
- `nonebot-adapter-onebot>=2.0.0` - OneBot 适配器
- `nonebot-plugin-apscheduler>=0.3.0` - 定时任务
- `aiohttp>=3.8.0` - 异步 HTTP 客户端
- `pydantic>=1.10.0` - 数据验证
- `pydantic-settings>=2.0.0` - 配置管理
- `python-dotenv>=0.19.0` - 环境变量加载
- `loguru>=0.6.0` - 日志系统

#### 🗂️ 项目结构

```
CRCON_QQBOT/
├── src/                    # 源代码目录
│   ├── __init__.py        # 包初始化
│   ├── config.py          # 配置管理
│   ├── crcon_api.py       # CRCON API 客户端
│   └── plugins/           # 插件目录
│       ├── __init__.py    # 插件包初始化
│       ├── player_commands.py    # 玩家命令
│       ├── admin_commands.py     # 管理员命令
│       └── system_commands.py    # 系统命令
├── logs/                  # 日志目录
├── bot.py                 # 机器人主程序
├── test_bot.py           # 测试脚本
├── requirements.txt       # 依赖列表
├── .env.example          # 配置模板
├── .env                  # 实际配置文件
├── README.md             # 项目说明
├── INSTALL.md            # 安装指南
├── COMMANDS.md           # 命令手册
└── CHANGELOG.md          # 更新日志
```

#### 🌍 国际化支持

**多语言命令**
- 中文命令别名
- 英文命令支持
- 混合使用支持

**本地化消息**
- 中文错误提示
- 中文帮助信息
- 中文状态报告

#### 🔒 安全特性

**权限控制**
- 超级用户验证
- 群组权限管理
- 命令权限分级

**数据安全**
- 敏感信息脱敏
- 配置文件保护
- API 令牌安全

#### 📊 监控功能

**健康检查**
- API 连接状态监控
- 自动故障检测
- 状态报告生成

**性能监控**
- 内存使用统计
- 响应时间记录
- 错误率统计

#### 🎯 支持的地图

**官方地图**
- Omaha Beach (奥马哈海滩)
- Utah Beach (犹他海滩)
- Sainte-Marie-du-Mont (圣玛丽教堂)
- Sainte-Mère-Église (圣梅尔埃格利斯)
- Foy (佛伊)
- Purple Heart Lane (紫心小道)
- Carentan (卡朗坦)
- Hill 400 (400号高地)
- Hurtgen Forest (许特根森林)
- Kursk (库尔斯克)
- Stalingrad (斯大林格勒)
- Remagen (雷马根)
- Elsenborn Ridge (埃尔森博恩岭)
- Driel (德里尔)

#### 🔧 配置选项

**基础配置**
- 超级用户设置
- 机器人昵称
- 命令前缀

**API 配置**
- 双服务器支持
- 连接超时设置
- 重试机制配置

**功能开关**
- 健康检查开关
- 缓存功能开关
- 日志级别设置

**权限配置**
- 管理员群组
- 玩家群组
- 权限验证

---

## 📋 待办事项

### 🚀 计划中的功能

**v1.1.0**
- [ ] 玩家统计功能
- [ ] 服务器性能监控
- [ ] 自定义命令别名
- [ ] 批量操作优化

**v1.2.0**
- [ ] Web 管理界面
- [ ] 数据库支持
- [ ] 高级权限系统
- [ ] 插件热重载

### 🐛 已知问题

**当前版本**
- 无已知严重问题

### 💡 改进建议

**性能优化**
- API 响应缓存优化
- 内存使用优化
- 并发处理优化

**用户体验**
- 命令自动补全
- 更友好的错误提示
- 操作确认机制

**功能增强**
- 更多地图支持
- 自定义惩罚类型
- 高级搜索功能

---

### 代码规范

- 遵循 PEP 8 代码风格
- 添加适当的注释和文档
- 编写单元测试
- 更新相关文档

### 问题报告

请在 GitHub Issues 中报告问题，包含以下信息：
- 问题描述
- 复现步骤
- 预期行为
- 实际行为
- 环境信息

---

## 📄 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情。

---

## 🙏 致谢

感谢以下项目和贡献者：

- [NoneBot2](https://github.com/nonebot/nonebot2) - 优秀的 Python 机器人框架
- [go-cqhttp](https://github.com/Mrs4s/go-cqhttp) - 高性能的 OneBot 实现
- [CRCON](https://github.com/MarechJ/hll_rcon_tool) - Hell Let Loose 服务器管理工具
- [NapCat](https://github.com/NapNeko/NapCatQQ) - 基于 NTQQ 的 Bot 协议端实现
- 所有测试用户和反馈提供者

---

*最后更新: 2025-10-16*